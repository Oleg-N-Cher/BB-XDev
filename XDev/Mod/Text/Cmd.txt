(* Copyright (C) 2012-2013 Oleg N. Cher, VEDAsoft Oberon Club *)
(* http://zx.oberon2.ru *)

MODULE XDevCmd;
IMPORT
	Controllers, Dialog, Files, HostFiles, i21sysCalls, Kernel,
	XDevMisc, Ofront := OfrontCmd, OfrontBrowser, OfrontOPM, StdLog,
	Strings, TextModels, TextViews, Windows;

CONST
	BinDir = "Bin";
	ObjDir = "Obj";
	NotFound = -1;

VAR
	rootDir: HostFiles.FullName;
	Is64BitWindows: BOOLEAN;

PROCEDURE Open;
BEGIN
	Dialog.ShowStatus("#XDev:Building");
	StdLog.buf.Delete(0, StdLog.buf.Length());
END Open;

PROCEDURE Close;
BEGIN
	StdLog.text.Append(StdLog.buf);
	IF OfrontOPM.noerr THEN Dialog.ShowStatus("#XDev:Ok") END;
	Kernel.Cleanup;
END Close;

PROCEDURE GetNameWoExt (name: ARRAY OF CHAR; OUT woext: ARRAY OF CHAR);
CONST
	ExtDelimiter = ".";
VAR
	pos, lastpos: INTEGER;
BEGIN
	pos := LEN(name$);
	Strings.Find(name, ExtDelimiter, 0, lastpos);
	WHILE lastpos # NotFound DO
		pos := lastpos;
		Strings.Find(name, ExtDelimiter, lastpos + 1, lastpos);
	END;
	woext := name$; woext[pos] := 0X;
END GetNameWoExt;

PROCEDURE GetSubsysDirByLocator (loc: Files.Locator; OUT subdir: ARRAY OF CHAR);
VAR
	s1, s2: HostFiles.FullName; dis, i, j, pos: INTEGER; ch: CHAR;
BEGIN
	subdir := "";
	WITH loc: HostFiles.Locator DO
		Strings.Find(loc.path, rootDir, 0, pos);
		IF pos = 0 THEN (* rootDir found in loc.path. *)
			dis := LEN(rootDir$) + 1(*"/"*);
		ELSE
			dis := 0;
		END;
		i := 0; ch := loc.path[dis]; pos := 0; j := 0;
		WHILE ch # 0X DO
			IF (ch = "\") OR (ch = "/") THEN
				ch := "/"; pos := i + 1; j := 0
			ELSE
				s2[j] := ch; INC(j);
			END;
			s1[i] := ch; INC(i); ch := loc.path[i + dis];
		END;
		s1[pos] := 0X; s2[j] := 0X;
		IF (s2[0] = 0X) OR ((CAP(s2[0]) = "M") & (CAP(s2[1]) = "O")
			& (CAP(s2[2]) = "D") & (s2[3] = 0X)) THEN
				subdir := s1$;
		ELSE
				subdir := s1$ + s2$ + "/";
		END;
	END;
END GetSubsysDirByLocator;

PROCEDURE Exists (loc: Files.Locator; IN fileName: ARRAY OF CHAR): BOOLEAN;
VAR
	f: Files.File; found: BOOLEAN;
BEGIN
	f := Files.dir.Old(loc, fileName$, TRUE);
	found := f # NIL;
	IF found THEN f.Close END;
RETURN found
END Exists;

PROCEDURE HaveMainAttribute (t: TextModels.Model): BOOLEAN;
VAR
	ch: CHAR; reader: TextModels.Reader;

	PROCEDURE Match (IN s: ARRAY OF CHAR): BOOLEAN;
	VAR
		i, n: INTEGER;
	BEGIN
		i := 0; n := LEN(s$);
		WHILE ~reader.eot & (ch = " ") DO reader.ReadChar(ch) END;
		WHILE ~reader.eot & (i < n) & (ch = s[i]) DO
			reader.ReadChar(ch); INC(i);
		END;
		RETURN i = n
	END Match;

	BEGIN
		ASSERT(t # NIL, 20);
		reader := t.NewReader(reader); reader.SetPos(0);
		WHILE ~reader.eot DO
			reader.ReadChar(ch);
			IF Match("(*") & Match("$MAIN") THEN RETURN TRUE END;
		END;
		RETURN FALSE
	END HaveMainAttribute;

PROCEDURE OfrontCompile* ; (** Call "Bin/compile.bat" script. *)
VAR
	t: TextModels.Model; w: Windows.Window; 
	loc: Files.Locator; name, dir: Files.Name;
	spacePos: INTEGER;
BEGIN
	Open;
	(* Try to find exact file name of current opened document: *)
	t := TextViews.FocusText();
	IF t # NIL THEN
		w := Windows.dir.Focus(Controllers.targetPath);
		IF (w # NIL) & (w.loc # NIL) & (w.name # "") THEN (* File name found. *)
			GetSubsysDirByLocator(w.loc, dir);
			(* Launch the translation by Ofront: *)
			OfrontOPM.SetWorkDir(dir, dir, TRUE, "");
			OfrontOPM.options.mainprog := HaveMainAttribute(t);
			Dialog.UpdateBool(OfrontOPM.options.mainprog);
			IF ~Ofront.TranslateDone() THEN Close; RETURN END;

			GetNameWoExt(w.name, name);
			Strings.Find(name, " ", 0, spacePos);
			IF spacePos # NotFound THEN
				StdLog.String("Module's file name must not contain a space.");
				StdLog.Ln;
				Close; RETURN
			END;

			(* Main compiling thread: *)
			loc := Files.dir.This(dir + BinDir);
			IF Exists(loc, "compile.bat") THEN (* Start "Bin/compile.bat Module". *)
				loc := Files.dir.This(dir + ObjDir); (* Start in /Obj directory. *)
				(* StdLog.String(loc(HostFiles.Locator).path$); StdLog.Ln; *)
				i21sysCalls.StartAt(loc, "..\Bin\compile.bat " + name$);
			ELSE
				StdLog.String('"' + dir + BinDir + '/' + 'compile.bat" not found.');
				StdLog.Ln;
			END;

			IF ~Is64BitWindows THEN Close; RETURN END;
			(* Additional compiling thread: *)
			loc := Files.dir.This(dir + BinDir);
			IF Exists(loc, "compile64.bat") THEN (* Start "Bin/compile64.bat Mod". *)
				OfrontOPM.SetWorkDir(dir, dir, TRUE, "64");
				IF ~Ofront.TranslateDone() THEN Close; RETURN END;
				loc := Files.dir.This(dir + ObjDir + "64"); (* Start in /Obj64 *)
				i21sysCalls.StartAt(loc, "..\Bin\compile64.bat " + name$);
			END;

		ELSE (* Module's file name not found. *)
			StdLog.String("First, specify a file name of the module, please.");
			StdLog.Ln;
		END;
	ELSE
		Dialog.ShowMsg("#XDev:NoTextViewFound")
	END;
	Close
END OfrontCompile;

PROCEDURE OfrontBuild* ; (** Call a BAT file that is appropriate to a source. *)
VAR
	t: TextModels.Model; w: Windows.Window; 
	loc: Files.Locator; name, dir: Files.Name;
	spacePos: INTEGER;
BEGIN
	Open;
	(* Try to find exact file name of current opened document: *)
	t := TextViews.FocusText();
	IF t # NIL THEN
		w := Windows.dir.Focus(Controllers.targetPath);
		IF (w # NIL) & (w.loc # NIL) & (w.name # "") THEN (* File name found. *)
			GetSubsysDirByLocator(w.loc, dir);
			(* Launch the translation by Ofront: *)
			OfrontOPM.SetWorkDir(dir, dir, TRUE, "");
			OfrontOPM.options.mainprog := HaveMainAttribute(t);
			Dialog.UpdateBool(OfrontOPM.options.mainprog);
			IF ~Ofront.TranslateDone() THEN Close; RETURN END;

			(* Main building thread: *)
			loc := Files.dir.This(dir + ObjDir);
			GetNameWoExt(w.name, name); name := name$ + ".bat";
			IF Exists(loc, name) THEN
				i21sysCalls.StartAt(loc, name); (* Start "Obj/Module.bat" *)
			ELSE
				loc := Files.dir.This(dir + BinDir);
				IF Exists(loc, "build.bat") THEN (* Start "Bin/build.bat Module". *)
					GetNameWoExt(w.name, name);
					Strings.Find(name, " ", 0, spacePos);
					IF spacePos # NotFound THEN
						StdLog.String("Module's file name must not contain a space.");
						StdLog.Ln;
						Close; RETURN
					END;
					loc := Files.dir.This(dir + ObjDir); (* Start in /Obj directory. *)
					(* StdLog.String(loc(HostFiles.Locator).path$); StdLog.Ln; *)
					i21sysCalls.StartAt(loc, "..\Bin\build.bat " + name$);
				ELSE
					StdLog.String(
						'"' + dir + ObjDir + '/' + name + '"' + ' or ' +
						'"' + dir + BinDir + '/' + 'build.bat" not found.');
					StdLog.Ln;
				END;
			END;

			IF ~Is64BitWindows THEN Close; RETURN END;

			(* Additional building thread: *)
			loc := Files.dir.This(dir + ObjDir + "64"); (* Start in /Obj64 *)
			GetNameWoExt(w.name, name); name := name$ + ".bat";
			IF Exists(loc, name) THEN
				OfrontOPM.SetWorkDir(dir, dir, TRUE, "64");
				IF ~Ofront.TranslateDone() THEN Close; RETURN END;
				i21sysCalls.StartAt(loc, name); (* Start "Obj64/Module.bat" *)
			ELSE
				loc := Files.dir.This(dir + BinDir);
				IF Exists(loc, "build64.bat") THEN (* Start "Bin/build64.bat Module". *)
					GetNameWoExt(w.name, name);
					Strings.Find(name, " ", 0, spacePos);
					IF spacePos # NotFound THEN
						StdLog.String("Module's file name must not contain a space.");
						StdLog.Ln;
						Close; RETURN
					END;
					OfrontOPM.SetWorkDir(dir, dir, TRUE, "64");
					IF ~Ofront.TranslateDone() THEN Close; RETURN END;
					loc := Files.dir.This(dir + ObjDir + "64"); (* Start in /Obj64 *)
					i21sysCalls.StartAt(loc, "..\Bin\build64.bat " + name$);
				END;
			END;

		ELSE (* Module's file name not found. *)
			StdLog.String("First, specify a file name of the module, please.");
			StdLog.Ln;
		END;
	ELSE
		Dialog.ShowMsg("#XDev:NoTextViewFound")
	END;
	Close
END OfrontBuild;

PROCEDURE ShowDef* ; (** Set work paths and call OfrontBrowser.ShowDef. *)
VAR
	t: TextModels.Model; w: Windows.Window; dir: Files.Name;
BEGIN
	(* Try to find exact file name of current opened document: *)
	t := TextViews.FocusText();
	IF t # NIL THEN
		w := Windows.dir.Focus(Controllers.targetPath);
		IF (w # NIL) & (w.loc # NIL) & (w.name # "") THEN (* File name found. *)
			GetSubsysDirByLocator(w.loc, dir);
			(* Call the OfrontBrowser.ShowDef with the defined work paths: *)
			OfrontOPM.SetWorkDir(dir, dir, TRUE, "");
			OfrontBrowser.ShowDef;
		END;
	END;
END ShowDef;

BEGIN
	rootDir := Files.dir.This("")(HostFiles.Locator).path$;
	Is64BitWindows := XDevMisc.Is64BitWindows();
END XDevCmd.